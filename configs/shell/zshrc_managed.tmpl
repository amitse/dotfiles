# Chezmoi-managed zsh configuration
# This file contains the main zsh configuration managed by chezmoi
# It's sourced from .zshrc to avoid conflicts with existing configurations

# Set default editor
export EDITOR="${EDITOR:-vim}"
export VISUAL="${VISUAL:-$EDITOR}"

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt SHARE_HISTORY          # Share history between sessions
setopt HIST_VERIFY            # Show command before executing from history
setopt HIST_IGNORE_DUPS       # Ignore duplicate commands
setopt HIST_IGNORE_SPACE      # Ignore commands starting with space
setopt HIST_REDUCE_BLANKS     # Remove extra blanks from commands

# Directory navigation
setopt AUTO_CD                # Auto cd when typing directory name
setopt AUTO_PUSHD             # Push directories to stack
setopt PUSHD_IGNORE_DUPS      # Ignore duplicate directories in stack
setopt CORRECT                # Correct typos in commands

# Completion system (only if not already loaded)
if ! command -v compinit >/dev/null 2>&1; then
    autoload -Uz compinit
    compinit
fi

# Case insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
# Colored completion
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
# Menu selection
zstyle ':completion:*' menu select

{{- if lookPath "fzf" }}
# FZF integration
if command -v fzf >/dev/null 2>&1; then
    # Key bindings
    source <(fzf --zsh) 2>/dev/null || {
        # Fallback for older fzf versions
        if [ -f ~/.fzf.zsh ]; then
            source ~/.fzf.zsh
        elif [ -f /usr/share/fzf/key-bindings.zsh ]; then
            source /usr/share/fzf/key-bindings.zsh
            source /usr/share/fzf/completion.zsh
        fi
    }
    
    # Environment variables
    export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"' 2>/dev/null || export FZF_DEFAULT_COMMAND='find . -type f'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border --bind=ctrl-u:preview-half-page-up,ctrl-d:preview-half-page-down'
fi
{{- end }}

{{- if lookPath "zoxide" }}
# Zoxide integration (smart cd)
if command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init zsh)"
fi
{{- end }}

# Source our modern CLI tool aliases
if [ -f ~/.config/shell/aliases.sh ]; then
    source ~/.config/shell/aliases.sh
fi

# Add local bin to PATH if it exists
if [ -d "$HOME/.local/bin" ]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# Cargo/Rust binaries
if [ -d "$HOME/.cargo/bin" ]; then
    export PATH="$HOME/.cargo/bin:$PATH"
fi

{{- if eq .chezmoi.os "darwin" }}
# macOS-specific settings
# Homebrew
if [ -d "/opt/homebrew/bin" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
fi

# GNU tools (if installed via Homebrew)
if [ -d "/opt/homebrew/opt/coreutils/libexec/gnubin" ]; then
    export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH"
fi
{{- end }}