# macOS Platform Configuration
# macOS-specific settings, aliases, and functions

{{- if eq .chezmoi.os "darwin" }}

# macOS-specific environment variables
export BROWSER="${BROWSER:-open}"

# Homebrew setup
{{- if lookPath "brew" }}
# Homebrew path setup (for Apple Silicon and Intel Macs)
if [[ -d "/opt/homebrew" ]]; then
    export HOMEBREW_PREFIX="/opt/homebrew"
elif [[ -d "/usr/local/Homebrew" ]]; then
    export HOMEBREW_PREFIX="/usr/local"
fi

# Homebrew aliases
alias brewup='brew update && brew upgrade && brew cleanup'
alias brewinfo='brew info'
alias brewsearch='brew search'
alias brewinstall='brew install'
alias brewuninstall='brew uninstall'
alias brewlist='brew list'
alias brewservices='brew services'
alias brewdeps='brew deps --tree'

# Cask shortcuts
alias cask='brew install --cask'
alias casklist='brew list --cask'
alias caskinfo='brew info --cask'

# Homebrew maintenance
brew_maintenance() {
    echo "ğŸº Running Homebrew maintenance..."
    brew update
    brew upgrade
    brew cleanup
    brew doctor
    echo "âœ… Homebrew maintenance complete"
}

# Install essential development tools via Homebrew
brew_dev_setup() {
    echo "ğŸ”§ Installing development tools via Homebrew..."
    brew install git curl wget tree jq bat ripgrep fd fzf
    brew install --cask visual-studio-code
    echo "âœ… Development tools installed"
}
{{- end }}

# Package management with multiple managers
{{- if lookPath "port" }}
# MacPorts
alias portinstall='sudo port install'
alias portsearch='port search'
alias portupgrade='sudo port upgrade outdated'
alias portlist='port installed'
{{- end }}

# System information
alias sysinfo='system_profiler SPSoftwareDataType'
alias hwinfo='system_profiler SPHardwareDataType'
alias meminfo='vm_stat'
alias cpuinfo='sysctl -n machdep.cpu.brand_string'

# macOS-specific file operations
alias ls='ls -G'
alias ll='ls -alFG'
alias la='ls -AG'
alias l='ls -CFG'

# Show/hide hidden files in Finder
alias showfiles='defaults write com.apple.finder AppleShowAllFiles YES; killall Finder'
alias hidefiles='defaults write com.apple.finder AppleShowAllFiles NO; killall Finder'

# Quick Look
alias ql='qlmanage -p'

# Clipboard utilities
alias pbcopy='pbcopy'
alias pbpaste='pbpaste'
alias clip='pbcopy'
alias clipout='pbpaste'

# Network utilities
alias flushdns='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'
alias localip="ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1'"

# Application management
alias appstore='mas'  # If mas is installed
alias finder='open -a Finder'
alias safari='open -a Safari'
alias chrome='open -a "Google Chrome"'
alias code='open -a "Visual Studio Code"'

# System utilities
alias cpu_usage='top -l 1 -s 0 | grep "CPU usage"'
alias disk_usage='df -h'
alias who_using_port='lsof -i'

# macOS system settings
macos_setup() {
    echo "ğŸ Configuring macOS settings..."
    
    # Show hidden files in Finder
    defaults write com.apple.finder AppleShowAllFiles YES
    
    # Show file extensions
    defaults write NSGlobalDomain AppleShowAllExtensions -bool true
    
    # Disable the "Are you sure you want to open this application?" dialog
    defaults write com.apple.LaunchServices LSQuarantine -bool false
    
    # Enable tap to click
    defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
    
    # Set fast key repeat
    defaults write NSGlobalDomain KeyRepeat -int 2
    defaults write NSGlobalDomain InitialKeyRepeat -int 15
    
    # Show battery percentage
    defaults write com.apple.menuextra.battery ShowPercent YES
    
    # Restart affected applications
    killall Finder
    killall SystemUIServer
    
    echo "âœ… macOS settings configured"
    echo "â„¹ï¸  Some changes may require a restart to take effect"
}

# Xcode and development tools
{{- if lookPath "xcode-select" }}
xcode_setup() {
    echo "ğŸ”¨ Setting up Xcode command line tools..."
    xcode-select --install 2>/dev/null || echo "Xcode tools already installed"
    echo "âœ… Xcode setup complete"
}

xcode_reset() {
    echo "ğŸ”„ Resetting Xcode command line tools..."
    sudo xcode-select --reset
    xcode-select --install
    echo "âœ… Xcode tools reset"
}
{{- end }}

# Security and privacy
{{- if lookPath "security" }}
# Keychain utilities
keychain_list() {
    security list-keychains
}

keychain_unlock() {
    security unlock-keychain login.keychain
}

# Certificate management
cert_list() {
    security find-certificate -a -p /System/Library/Keychains/SystemRootCertificates.keychain | grep "subject="
}
{{- end }}

# Disk utilities
disk_info() {
    echo "ğŸ’¿ Disk Information"
    echo "=================="
    
    echo "ğŸ—‚ï¸  Disk Usage:"
    df -h
    echo ""
    
    echo "ğŸ” Largest Directories:"
    du -h -d 1 ~/ 2>/dev/null | sort -hr | head -10
    echo ""
    
    echo "ğŸ—‘ï¸  Trash Size:"
    du -sh ~/.Trash 2>/dev/null || echo "Trash is empty"
    echo ""
    
    echo "ğŸ“¦ Package Caches:"
    if [ -d ~/Library/Caches ]; then
        du -sh ~/Library/Caches 2>/dev/null
    fi
    if [ -d ~/.npm ]; then
        du -sh ~/.npm 2>/dev/null
    fi
    if [ -d ~/.cargo ]; then
        du -sh ~/.cargo 2>/dev/null
    fi
}

# Clean up system
macos_cleanup() {
    echo "ğŸ§¹ Cleaning up macOS system..."
    
    # Empty trash
    rm -rf ~/.Trash/*
    echo "ğŸ—‘ï¸  Emptied Trash"
    
    # Clear system caches (user level)
    rm -rf ~/Library/Caches/*
    echo "ğŸ§½ Cleared user caches"
    
    # Clear downloads folder of old files (older than 30 days)
    find ~/Downloads -type f -mtime +30 -delete 2>/dev/null
    echo "ğŸ“ Cleaned old downloads"
    
    {{- if lookPath "brew" }}
    # Clean Homebrew
    brew cleanup
    echo "ğŸº Cleaned Homebrew"
    {{- end }}
    
    # Purge inactive memory
    sudo purge 2>/dev/null
    echo "ğŸ’¾ Purged inactive memory"
    
    echo "âœ… System cleanup complete"
}

# App Store utilities (if mas is installed)
{{- if lookPath "mas" }}
alias maslist='mas list'
alias masinstall='mas install'
alias masupgrade='mas upgrade'
alias massearch='mas search'

mas_update_all() {
    echo "ğŸª Updating App Store apps..."
    mas upgrade
    echo "âœ… App Store apps updated"
}
{{- end }}

# Time Machine utilities
tm_status() {
    tmutil status
}

tm_exclude() {
    local path="$1"
    if [ -z "$path" ]; then
        echo "Usage: tm_exclude <path>"
        return 1
    fi
    sudo tmutil addexclusion "$path"
    echo "âœ… Added to Time Machine exclusions: $path"
}

tm_include() {
    local path="$1"
    if [ -z "$path" ]; then
        echo "Usage: tm_include <path>"
        return 1
    fi
    sudo tmutil removeexclusion "$path"
    echo "âœ… Removed from Time Machine exclusions: $path"
}

# Docker for Mac utilities
{{- if lookPath "docker" }}
docker_mac_reset() {
    echo "ğŸ³ Resetting Docker for Mac..."
    osascript -e 'quit app "Docker"'
    sleep 5
    open -a Docker
    echo "âœ… Docker for Mac reset"
}
{{- end }}

# Battery and power management
battery_info() {
    pmset -g batt
}

power_settings() {
    echo "ğŸ”‹ Power Settings"
    echo "================"
    pmset -g
}

caffeine() {
    echo "â˜• Preventing sleep..."
    caffeinate -d
}

# Network diagnostics
network_info() {
    echo "ğŸŒ Network Information"
    echo "===================="
    
    echo "ğŸ“¡ Active Connections:"
    netstat -rn | grep default
    echo ""
    
    echo "ğŸ”— Network Interfaces:"
    ifconfig | grep -E "(flags|inet )"
    echo ""
    
    echo "ğŸ“¶ Wi-Fi Info:"
    /System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport -I
    echo ""
    
    echo "ğŸŒ External IP:"
    curl -s ifconfig.me && echo
}

# macOS system status
macos_status() {
    echo "ğŸ macOS System Status"
    echo "====================="
    
    echo "ğŸ’» System Info:"
    sw_vers
    echo ""
    
    echo "ğŸ§  Memory Pressure:"
    memory_pressure
    echo ""
    
    echo "ğŸ”¥ CPU Usage:"
    top -l 1 -s 0 | grep "CPU usage"
    echo ""
    
    echo "ğŸ’¿ Disk Usage:"
    df -h / | tail -1
    echo ""
    
    echo "ğŸ”‹ Battery Status:"
    pmset -g batt | grep -E "(Now drawing|Battery)"
    echo ""
    
    echo "ğŸŒ¡ï¸  Thermal State:"
    pmset -g therm
}

# macOS help function
macos_help() {
    echo "ğŸ macOS Platform Functions:"
    echo ""
    echo "ğŸº Homebrew:"
    echo "  â€¢ brewup             - Update and upgrade all packages"
    echo "  â€¢ brew_maintenance   - Complete Homebrew cleanup"
    echo "  â€¢ brew_dev_setup     - Install essential dev tools"
    echo ""
    echo "âš™ï¸  System Configuration:"
    echo "  â€¢ macos_setup        - Configure optimal system settings"
    echo "  â€¢ macos_cleanup      - Clean caches and old files"
    echo "  â€¢ macos_status       - System status dashboard"
    echo ""
    echo "ğŸ”§ Development:"
    echo "  â€¢ xcode_setup        - Install Xcode command line tools"
    echo "  â€¢ xcode_reset        - Reset Xcode tools"
    echo ""
    echo "ğŸ’¿ Disk Management:"
    echo "  â€¢ disk_info          - Disk usage information"
    echo "  â€¢ tm_exclude <path>  - Exclude from Time Machine"
    echo ""
    echo "ğŸ”‹ Power & Battery:"
    echo "  â€¢ battery_info       - Battery status"
    echo "  â€¢ caffeine           - Prevent system sleep"
    echo ""
    echo "ğŸŒ Network:"
    echo "  â€¢ network_info       - Network configuration"
    echo "  â€¢ flushdns           - Flush DNS cache"
    echo ""
    echo "ğŸ”’ Files & Security:"
    echo "  â€¢ showfiles/hidefiles - Toggle hidden files in Finder"
    echo "  â€¢ keychain_list      - List keychains"
}

{{- end }}