#!/bin/bash

# Secrets Management Setup Script
# This script helps set up your chosen secrets backend

{{- $backend := .data.secrets.backend | default "env" }}

set -e

echo "ğŸ” Setting up secrets management (backend: {{ $backend }})"

{{- if eq $backend "op" }}
# 1Password setup
if ! command -v op &> /dev/null; then
    echo "ğŸ“¦ Installing 1Password CLI..."
    {{- if eq .chezmoi.os "darwin" }}
    if command -v brew &> /dev/null; then
        brew install 1password-cli
    else
        echo "âŒ Homebrew required for 1Password CLI installation on macOS"
        exit 1
    fi
    {{- else if eq .chezmoi.os "linux" }}
    # Download and install 1Password CLI for Linux
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main' | sudo tee /etc/apt/sources.list.d/1password.list
    sudo apt update && sudo apt install 1password-cli
    {{- else }}
    echo "âŒ 1Password CLI installation not supported on {{ .chezmoi.os }}"
    exit 1
    {{- end }}
fi

# Check if already authenticated
if op account list &> /dev/null; then
    echo "âœ… 1Password CLI already authenticated"
else
    echo "ğŸ”‘ Please authenticate with 1Password:"
    echo "   op account add --address your-account.1password.com"
    echo "   (Follow the prompts to complete authentication)"
fi

{{- else if eq $backend "bw" }}
# Bitwarden setup
if ! command -v bw &> /dev/null; then
    echo "ğŸ“¦ Installing Bitwarden CLI..."
    {{- if eq .chezmoi.os "darwin" }}
    if command -v brew &> /dev/null; then
        brew install bitwarden-cli
    else
        npm install -g @bitwarden/cli
    fi
    {{- else }}
    npm install -g @bitwarden/cli
    {{- end }}
fi

# Configure server if specified
{{- if .data.secrets.bw_server }}
bw config server {{ .data.secrets.bw_server }}
{{- end }}

# Check authentication
if [[ -z "$BW_SESSION" ]]; then
    echo "ğŸ”‘ Please authenticate with Bitwarden:"
    echo "   bw login"
    echo "   export BW_SESSION=\"\$(bw unlock --raw)\""
    echo "   (Add the export command to your shell profile)"
else
    echo "âœ… Bitwarden CLI authenticated"
fi

{{- else if eq $backend "env" }}
# Environment variables setup
echo "ğŸŒ Using environment variables for secrets"
echo ""
echo "ğŸ“‹ Set up your secrets by adding these to your shell profile:"
echo "   export GITHUB_TOKEN=\"your_github_token_here\""
echo "   export DATABASE_URL=\"your_database_url_here\""
echo "   export AWS_ACCESS_KEY_ID=\"your_aws_key_here\""
echo "   export AWS_SECRET_ACCESS_KEY=\"your_aws_secret_here\""
echo ""
echo "ğŸ’¡ For production, consider migrating to 1Password or Bitwarden"

{{- else if eq $backend "file" }}
# File-based secrets setup
SECRETS_DIR="$HOME/.secrets"
echo "ğŸ“ Setting up file-based secrets in $SECRETS_DIR"

if [[ ! -d "$SECRETS_DIR" ]]; then
    mkdir -p "$SECRETS_DIR"
    chmod 700 "$SECRETS_DIR"
    echo "âœ… Created secrets directory: $SECRETS_DIR"
fi

echo ""
echo "ğŸ“‹ Create your secret files:"
echo "   echo 'your_token_here' > $SECRETS_DIR/github_token"
echo "   echo 'your_db_url_here' > $SECRETS_DIR/database_url"
echo "   chmod 600 $SECRETS_DIR/*"
echo ""
echo "âš ï¸  Remember to backup these files securely!"

{{- end }}

echo ""
echo "âœ… Secrets management setup complete!"
echo "ğŸ”„ Run 'chezmoi apply' to use your secrets in configuration files"